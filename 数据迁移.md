数据库迁移
========

## 用户表 （core_gkuser）
新果库用户表结构

去掉 username 字段，使用 email 作为 username。

email 字段加上 唯一属性。 

根本解决果库用户邮箱重复问题。

* 检查用户 email 重复 SQL
 
```
select count(*) as e,id, email 
	from auth_user where is_active = 1 
		group by email having e > 1;
```

* 获取所有重复用户的信息
 
```
select * from auth_user 
	where email in 
		(select email from 
			(select email, count(*) as c from auth_user where is_active = 1 group by email having c > 1 order by c desc ) 
		as e) ;
```

* 将所有重复用户设置为 disable
 
```
update auth_user set is_active = 0
	where email in 
		(select email from 
			(select email, count(*) as c from auth_user where is_active = 1 group by email having c > 1 order by c desc ) 
		as e) ;
```

* 表结构
 
```
| core_gkuser | CREATE TABLE `core_gkuser` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `password` varchar(128) NOT NULL,
  `last_login` datetime NOT NULL,
  `email` varchar(255) NOT NULL,
  `is_active` tinyint(1) NOT NULL,
  `is_admin` tinyint(1) NOT NULL,
  `date_joined` datetime NOT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `email` (`email`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 |
```

* 迁移用 SQL
 
```
insert into core_gkuser (id, email, password, is_admin, is_active, last_login, date_joined) 
	select id, email, password, is_staff, is_active, last_login, date_joined 
		from guoku.auth_user
			where is_active = 1;
```

## 用户 Profile 

* 表结构
 
```
CREATE TABLE `core_user_profile` (
    `id` integer AUTO_INCREMENT NOT NULL PRIMARY KEY,
    `user_id` integer NOT NULL UNIQUE,
    `nickname` varchar(64) NOT NULL UNIQUE,
    `location` varchar(32),
    `city` varchar(32),
    `gender` varchar(2) NOT NULL,
    `bio` varchar(1024),
    `website` varchar(1024),
    `avatar` varchar(255) NOT NULL,
    `email_verified` bool NOT NULL
);
```

* 迁移用 SQL

```
insert into core_user_profile
	select p.id, p.user_id, p.nickname , p.location, p.city, p.gender, p.bio, p.website, a.avatar_large, p.email_verified
		from guoku.base_user_profile as p join guoku.auth_user as u join guoku.base_avatar as a  on  u.id=p.user_id and u.id = a.user_id  
			where u.is_active=1;
```

## 分类表
```
+--------+--------------+------+-----+---------+----------------+
| Field  | Type         | Null | Key | Default | Extra          |
+--------+--------------+------+-----+---------+----------------+
| id     | int(11)      | NO   | PRI | NULL    | auto_increment |
| title  | varchar(128) | NO   | MUL | NULL    |                |
| status | tinyint(1)   | NO   | MUL | NULL    |                |
+--------+--------------+------+-----+---------+----------------+
```

* 迁移 SQL

```
insert into core_category select * from guoku.base_neo_category_group;
```

## 子分类表
```
+------------------+--------------+------+-----+---------+----------------+
| Field            | Type         | Null | Key | Default | Extra          |
+------------------+--------------+------+-----+---------+----------------+
| id               | int(11)      | NO   | PRI | NULL    | auto_increment |
| group_id         | int(11)      | NO   | MUL | NULL    |                |
| title            | varchar(128) | NO   | UNI | NULL    |                |
| image_store_hash | varchar(64)  | YES  | MUL | NULL    |                |
| status           | tinyint(1)   | NO   | MUL | NULL    |                |
+------------------+--------------+------+-----+---------+----------------+
```

* 迁移用 SQL

```
insert into core_sub_category select * from guoku.base_neo_category;
```

## 商品表
```
+---------------+---------------+------+-----+---------+----------------+
| Field         | Type          | Null | Key | Default | Extra          |
+---------------+---------------+------+-----+---------+----------------+
| id            | int(11)       | NO   | PRI | NULL    | auto_increment |
| user_id       | int(11)       | YES  | MUL | NULL    |                |
| entity_hash   | varchar(32)   | NO   | UNI | NULL    |                |
| category_id   | int(11)       | NO   | MUL | NULL    |                |
| brand         | varchar(256)  | NO   |     | NULL    |                |
| title         | varchar(256)  | NO   |     | NULL    |                |
| intro         | longtext      | NO   |     | NULL    |                |
| price         | decimal(20,2) | NO   | MUL | NULL    |                |
| mark          | int(11)       | NO   | MUL | NULL    |                |
| chief_image   | varchar(64)   | NO   |     | NULL    |                |
| detail_images | longtext      | NO   |     | NULL    |                |
| created_time  | datetime      | NO   | MUL | NULL    |                |
| updated_time  | datetime      | NO   | MUL | NULL    |                |
| status        | int(11)       | NO   |     | NULL    |                |
+---------------+---------------+------+-----+---------+----------------+
```


```
insert into core_entity (id, user_id, entity_hash, category_id, brand, title, intro, price, mark, chief_image, detail_images, created_time, updated_time, status) 
	select id, creator_id, entity_hash, neo_category_id, brand, title, intro, price, mark, chief_image, detail_images, created_time, updated_time, weight 
		from guoku.base_entity where creator_id in (select id from core_gkuser);
```

## 点评表
```
| core_note | CREATE TABLE `core_note` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `user_id` int(11) NOT NULL,
  `entity_id` int(11) NOT NULL,
  `note` longtext,
  `post_time` datetime DEFAULT NULL,
  `updated_time` datetime NOT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `entity_id` (`entity_id`,`user_id`),
  KEY `core_note_6340c63c` (`user_id`),
  KEY `core_note_c096cf48` (`entity_id`),
  KEY `core_note_fdd15200` (`post_time`),
  KEY `core_note_b7cc06d7` (`updated_time`),
  CONSTRAINT `user_id_refs_id_98c4e08a` FOREIGN KEY (`user_id`) REFERENCES `auth_user` (`id`),
  CONSTRAINT `entity_id_refs_id_a30c4b02` FOREIGN KEY (`entity_id`) REFERENCES `core_entity` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 |
```

```
insert into core_note (id, user_id, entity_id, note, post_time, updated_time) 
	select id, creator_id, entity_id, note, created_time, updated_time 
		from guoku.base_note where weight > 0;
```

## 喜欢表

```
insert into core_entity_like 
select * from guoku.guoku_entity_like;
```
